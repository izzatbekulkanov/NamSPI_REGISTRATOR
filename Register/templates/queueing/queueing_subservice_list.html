{% extends "queueing/queueing_base.html" %}
{% load static %}

{% block title %}{{ section.name }} xizmatlari{% endblock %}

{% block content %}
<style>
    .section-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 2rem;
        text-shadow: 1px 1px 8px rgba(0, 0, 0, 0.6);
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 1.5rem;
        padding: 2rem;
        height: 100%;
        color: white;
        transition: all 0.3s ease;
    }

    .glass-card:hover {
        transform: scale(1.03);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    .back-btn {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Maxsus modal stillari */
    .custom-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1050;
    }

    .custom-modal-content {
        background: #ffffff;
        border-radius: 1.5rem;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .ticket-number {
        font-size: 4rem;
        font-weight: bold;
        color: #333;
        text-align: center;
        padding: 2rem 0;
    }

    .close-btn {
        background-color: #333;
        color: #ffffff;
        border: none;
        padding: 0.5rem 1.5rem;
        font-size: 1.2rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .close-btn:hover {
        background-color: #555;
    }
</style>

<div class="container py-5">
    <div class="mb-4">
        <a href="{% url 'queueing-section-list' %}" class="btn back-btn btn-sm">
            <i class="bi bi-arrow-left"></i> Ortga qaytish
        </a>
    </div>

    <h2 class="text-center section-title">{{ section.name }} xizmatlari</h2>

    {% if subservices %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for service in subservices %}
        <div class="col">
            <div class="glass-card text-center">
                <h5>{{ service.name }}</h5>
                <p>{{ service.description|default:"" }}</p>
                <button class="btn btn-outline-light btn-sm play-sound" onclick="getTicket({{ service.id }})">Navbat
                    olish
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-light text-center mt-4 text-dark bg-opacity-75">
        Bu bo‘limda hozircha hech qanday xizmat mavjud emas.
    </div>
    {% endif %}

    <!-- Maxsus modal -->
    <div class="custom-modal" id="ticketModal">
        <div class="custom-modal-content">
            <div id="ticketDisplay" class="ticket-number"></div>
            <button type="button" class="close-btn mt-4" onclick="closeModal()">Yopish</button>
        </div>
    </div>

    <!-- Printer bilan bog'liq iframe izoh sifatida yashirildi -->
    <!-- <iframe id="printFrame" style="display: none;"></iframe> -->
</div>
{% endblock %}

{% block script %}
<audio id="click-sound" src="{% static 'sound/click.wav' %}" preload="auto"></audio>

<script>
    const clickSound = document.getElementById("click-sound");
    const ticketModal = document.getElementById("ticketModal");

    function getTicket(serviceId) {
        clickSound.currentTime = 0;
        clickSound.play().catch(() => {});

        fetch(`/ticket/create/${serviceId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Navbat raqamini modalda katta ko'rsatish
                    const ticketDisplay = document.getElementById('ticketDisplay');
                    ticketDisplay.innerHTML = `Sizning navbat raqamingiz: ${data.ticket_number}`;

                    // Modalni ko'rsatish
                    ticketModal.style.display = 'flex';

                    // 10 soniyadan keyin modalni yopish va redirect qilish
                    setTimeout(() => {
                        ticketModal.style.display = 'none';
                        window.location.href = "{% url 'queueing-section-list' %}";
                    }, 10000);
                }
            });
    }

    function closeModal() {
        ticketModal.style.display = 'none';
        // Modal yopilganda darhol redirect qilish
        window.location.href = "{% url 'queueing-section-list' %}";
    }

    // Printer bilan bog'liq funksiya izoh sifatida yashirildi
    /*
    function printTicket(data) {
        const now = new Date();
        const time = now.toLocaleTimeString('uz-UZ');
        const date = now.toLocaleDateString('uz-UZ');

        const html = `
    <html>
      <head>
        <style>
          body {
            font-family: monospace;
            font-size: 12px;
            text-align: center;
            margin: 0;
            padding: 0;
          }
          .line {
            margin: 3px 0;
            font-size: 12px;
          }
          .logo {
            width: 50px;
            height: auto;
            margin-top: 2px;
          }
          .title {
            font-size: 14px;
            font-weight: bold;
            margin: 2px 0;
          }
          .web {
            font-size: 11px;
            margin: 0 0 3px 0;
          }
          .ticket {
            font-size: 48px;
            font-weight: bold;
            margin: 0px 0;
          }
          .datetime {
            font-size: 11px;
            margin-top: 2px;
          }
        </style>
      </head>
      <body onload="window.print()">
        <div class="line">────────────</div>
        <img class="logo" src="${window.location.origin}{% static 'img/logo.png' %}" alt="logo"><br>
        <div class="title">NamDPI | RTTM</div>
        <div class="web">www.namspi.uz</div>
        <div class="ticket">${data.ticket_number}</div>
        <div class="datetime">${time} ${date}</div>
        <div class="line">────────────</div>
      </body>
    </html>
  `;

        const printFrame = document.getElementById('printFrame');
        const frameWindow = printFrame.contentWindow || printFrame;
        frameWindow.document.open();
        frameWindow.document.write(html);
        frameWindow.document.close();
    }
    */
</script>
{% endblock %}